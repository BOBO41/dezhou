<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  
    PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"  
    "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">  
<mapper namespace="ndb">
	<insert id="addUser" parameterType="com.archy.dezhou.entity.UserInfo">
		insert into
		userinfo(name,uid,password,email,roommoney,allmoney,sex,pic,online,address,
		status,regtime,birthday,counttime,logintime,gold,exprience,exittime,zfmatchpoint,
		tzmatchpoint,cmatchpoint,loginnum,showtype,functiontype,usecount,visitnum,mobile,muid,
		sessionkey,iftest,createtime,maxhandstr,maxhandvalue)
		values (
		#{name,jdbcType=VARCHAR},
		#{uid,jdbcType=INTEGER},
		#{password,jdbcType=VARCHAR},
		#{email,jdbcType=VARCHAR},
		0,
		50000,
		#{sex,jdbcType=VARCHAR},
		'001',
		'false',
		'',
		'00',
		now(),
		#{birthday,jdbcType=VARCHAR},
		now(),
		now(),
		0,
		0,
		now(),
		'0',
		0,
		0,
		0,
		0,
		0,
		0,
		0,
		#{mobile,jdbcType=VARCHAR},
		#{muid,jdbcType=VARCHAR},
		#{sessionkey,jdbcType=VARCHAR},
		#{iftest,jdbcType=INTEGER},
		now(),
		'',
		0)
	</insert>

	<insert id="newUserAchievement" parameterType="com.archy.dezhou.entity.UserInfo">
	    insert into achievement (uid, num, gettime, ctype) values(#{uid},1,now(),#{ctype})
	</insert>
	
	<!-- 修改用户信息 -->
	<update id="updateUserInfo" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set
		name = #{name,jdbcType=VARCHAR},		
		roommoney = #{roommoney,jdbcType=INTEGER},
		password = #{password,jdbcType=VARCHAR},
		allmoney = #{allmoney,jdbcType=INTEGER},
		sex = #{sex,jdbcType=VARCHAR},
		pic = #{pic,jdbcType=VARCHAR},
		online = #{online,jdbcType=VARCHAR},
		address = #{address,jdbcType=VARCHAR},
		mobile = #{mobile, jdbcType=VARCHAR},
		email = #{email,jdbcType=VARCHAR},
		status = #{status,jdbcType=VARCHAR},
		regtime = #{regtime,jdbcType=VARCHAR},
		birthday = #{birthday,jdbcType=VARCHAR},
		counttime = #{counttime,jdbcType=VARCHAR},
		logintime = now(),
		gold = #{gold,jdbcType=INTEGER},
		exprience = #{exprience,jdbcType=INTEGER},
		exittime = #{exittime,jdbcType=VARCHAR},
		zfmatchpoint = #{zfmatchpoint,jdbcType=INTEGER},
		tzmatchpoint = #{tzmatchpoint,jdbcType=INTEGER},
		cmatchpoint = #{cmatchpoint,jdbcType=INTEGER},
		loginnum = #{loginnum,jdbcType=INTEGER},
		showtype = #{showtype,jdbcType=INTEGER},
		functiontype = #{functiontype,jdbcType=INTEGER},
		usecount = #{usecount,jdbcType=INTEGER},
		visitnum = #{visitnum,jdbcType=INTEGER},
		winnum = #{winnum,jdbcType=INTEGER},
		completenum = #{completenum,jdbcType=INTEGER},
		muid = #{muid,jdbcType=VARCHAR},
		ifrewards = #{ifrewards,jdbcType=BIGINT},
		maxhandstr = #{maxhandstr,jdbcType=VARCHAR},
		maxhandvalue = #{maxhandvalue,jdbcType=BIGINT}
		where uid = #{uid,jdbcType=INTEGER}
	</update>

	<!-- 重置用户登录时间 -->
	<update id="ResetUserTime" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set
		createtime=now(),lastconsume=now(),counttime=now(),logintime=now(),
		iftest= #{iftest}, muid= #{muid}, sessionkey= #{sessionkey} where
		muid= #{muid}
	</update>

	<!-- 重置密码 -->
	<update id="resetUserPassword" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set password = #{password,jdbcType=VARCHAR} where uid= #{uid,jdbcType=INTEGER}
	</update>

	<!-- 重置sessionKey -->
	<update id="resetsessionKey" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set sessionkey = #{sessionkey}, logintime=now() where muid = #{userId}
	</update>

	<!-- 将不充值和不购买道具的用户做登出处理，将用户的sessionkey设置为null -->
	<update id="setLogoutUser" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set sessionkey = null where muid= #{muid}
	</update>

	<update id="BuyGameTool" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set gold = #{gold} where uid = #{uid}
	</update>
	
	<update id="TodayCosumeUpdate0" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set todayconsumemoney = 0, lastconsume=now() where uid = #{uid} 
		and date(lastconsume) &lt;> date(now())
	</update>
	
	<update id="TodayCosumeUpdate1" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set todayconsumemoney = todayconsumemoney + #{todayconsumemoney}, lastconsume=now() 
		where uid= #{uid} and date(lastconsume) = date(now())
	</update>
	
	<update id="TodayCosumeUpdate2" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set todayconsumemoney=0, lastconsume=now() where date(lastconsume)&lt;&gt;date(now())
	</update>
	
	<update id="updateUserPassword" parameterType="com.archy.dezhou.entity.UserInfo">
		update userinfo set password = #{password,jdbcType=VARCHAR} where uid = #{uid,jdbcType=INTEGER} or email = #{email,jdbcType=VARCHAR}
	</update>
	
	<!-- 更新成就列表 -->
	<update id="updateUserAchievement" parameterType="com.archy.dezhou.entity.UserInfo">
		update achievement set num=num+1,gettime = now() where id = #{uid} and ctype = #{ctype}
	</update>
	
	<!-- 更新道具列表 -->
	<update id="updateUserDaoju" parameterType="com.archy.dezhou.entity.UserInfo">
		update daoju set num = #{num}, addtime=now() where uid = #{uid} and dtype = #{dtype}
	</update>
	
	<!-- 更新礼物列表 -->
	<update id="updateUserGift" parameterType="com.archy.dezhou.entity.UserInfo">
		update gift set num = #{num}, time = now() where mid = #{uid} and gtype = #{dtype}
	</update>
	
	<!-- 新增访问列表 -->
	<update id="usefacebag" parameterType="com.archy.dezhou.entity.UserInfo">
		update daoju set isUse = 'yes', useDate = now(), expireDate = ADDDATE(now(), expiredays) where id = #{id}
	</update>
	
	<delete id="deleteExcahgeCard" parameterType="com.archy.dezhou.entity.UserInfo">
	    delete from daoju where id = #{id}
	</delete>

	<!-- 判断用户是否注册过 -->
	<select id="ifRepeatName" parameterType="String" resultType="int">
		select count(*) as rcount from userinfo where uid = #{uid,jdbcType=INTEGER}
	</select>
	
	<!-- 查找注册过用户 -->
	<select id="ifRegistered" parameterType="String" resultType="int">
		select count(*) as rcount from userinfo where name = #{name,jdbcType=VARCHAR}
	</select>

	<!-- 获取用户信息 -->
	<select id="getUserInfo" parameterType="String" resultType="com.archy.dezhou.entity.UserInfo">
		select name, password, uid, email, roommoney, allmoney, sex, pic, online, address,
		status, regtime, birthday, counttime, logintime, gold, exprience, exittime, zfmatchpoint,
		tzmatchpoint, cmatchpoint, loginnum, showtype, functiontype, usecount, visitnum, mobile,
		maxhandstr, maxhandvalue,winnum,completenum
		from userinfo where uid = #{uid,jdbcType=VARCHAR}
	</select>

	<select id="getMaxUserId" resultType="int">
		select max(uid) as maxuid from userinfo
	</select>

	<select id="userLogin" parameterType="java.util.Map" resultType="com.archy.dezhou.entity.UserInfo">
		select * from userinfo where password = #{password,jdbcType=VARCHAR} and uid = #{uid,jdbcType=INTEGER}
	</select>

	<select id="userLoginMobile" parameterType="String" resultType="com.archy.dezhou.entity.UserInfo">
		select uid, muid from userinfo where muid = #{muid,jdbcType=VARCHAR}
	</select>

	<select id="userValidEmail" parameterType="String" resultType="com.archy.dezhou.entity.UserInfo">
		select uid,name from userinfo where email = #{email,jdbcType=VARCHAR}
	</select>

	<!-- 将不充值和不购买道具的用户做登出处理, 得到一个用户 -->
	<select id="getLogoutUser" parameterType="com.archy.dezhou.entity.UserInfo" resultType="com.archy.dezhou.entity.UserInfo">
		select muid from userinfo where iftest=0 and
		date(createtime) &lt;&gt; date(now())
		and sessionkey is not null order by createtime asc limit 1
	</select>


	<!-- 查询前筹码50名排行 -->
	<select id="rank" resultType="com.archy.dezhou.entity.UserInfo">
		select pic,name,uid,level,allmoney from userinfo order by allmoney desc limit 50
	</select>

</mapper>